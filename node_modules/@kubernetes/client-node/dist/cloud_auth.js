"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
// workaround for issue https://github.com/dchester/jsonpath/issues/96
const jsonpath = require("jsonpath/jsonpath.min");
const shelljs = tslib_1.__importStar(require("shelljs"));
class CloudAuth {
    isAuthProvider(user) {
        return user.authProvider.name === 'azure' ||
            user.authProvider.name === 'gcp';
    }
    getToken(user) {
        const config = user.authProvider.config;
        // This should probably be extracted as auth-provider specific plugins...
        let token = 'Bearer ' + config['access-token'];
        const expiry = config.expiry;
        if (expiry) {
            const expiration = Date.parse(expiry);
            if (expiration < Date.now()) {
                if (config['cmd-path']) {
                    const args = config['cmd-args'];
                    // TODO: Cache to file?
                    // TODO: do this asynchronously
                    let result;
                    try {
                        let cmd = config['cmd-path'];
                        if (args) {
                            cmd = `${cmd} ${args}`;
                        }
                        result = shelljs.exec(cmd);
                        if (result.code !== 0) {
                            throw new Error(result.stderr);
                        }
                    }
                    catch (err) {
                        throw new Error('Failed to refresh token: ' + err.message);
                    }
                    const output = result.stdout.toString();
                    const resultObj = JSON.parse(output);
                    let pathKey = config['token-key'];
                    // Format in file is {<query>}, so slice it out and add '$'
                    pathKey = '$' + pathKey.slice(1, -1);
                    config['access-token'] = jsonpath.query(resultObj, pathKey);
                    token = 'Bearer ' + config['access-token'];
                }
                else {
                    throw new Error('Token is expired!');
                }
            }
        }
        return token;
    }
}
exports.CloudAuth = CloudAuth;
//# sourceMappingURL=cloud_auth.js.map